// Generated by CoffeeScript 1.4.0
var getElectionName, getElectionTimes, getResultDelay, isUniversalElection, scrollToTop, submitForm;

jQuery(function() {
  $('#startDate, #endDate').parent().datepicker();
  $('#startTime, #endTime').timepicker({
    minuteStep: 5
  });
  $('label[rel="tooltip"]').tooltip();
  return $('#election-submit').click(submitForm);
});

submitForm = function() {
  var key, postData, value;
  if ($('#election-submit').hasClass('disabled')) {
    return false;
  }
  postData = {
    'name': getElectionName(),
    'start': getElectionTimes()['start'],
    'end': getElectionTimes()['end'],
    'result_delay': getResultDelay(),
    'universal': isUniversalElection()
  };
  for (key in postData) {
    value = postData[key];
    if (value === null) {
      scrollToTop();
      return false;
    }
  }
  $('#election-submit').addClass('disabled');
  return $.ajax({
    url: '/create-election',
    type: 'POST',
    data: {
      'formData': JSON.stringify(postData)
    },
    success: function(data) {
      var response;
      response = JSON.parse(data);
      scrollToTop();
      $('#server-response').addClass('alert');
      if (response['status'] === 'OK') {
        $('#server-response').addClass('alert-success');
      } else {
        $('#server-response').addClass('alert-error');
      }
      $('#server-response').html(response['msg']);
      return $('#server-response').hide().slideDown(1000);
    }
  });
};

scrollToTop = function() {
  return $('html, body').animate({
    scrollTop: $('#createForm').offset().top
  }, 500);
};

getElectionName = function() {
  var name, nameContainer;
  name = $('#name');
  nameContainer = name.parent().parent();
  nameContainer.removeClass('error');
  $('.errorMsgName').remove();
  if (!name.val()) {
    nameContainer.addClass('error');
    $("<span class='help-inline errorMsgName'>Please enter election " + "name.</span>").insertAfter(name);
    return null;
  }
  return name.val();
};

getElectionTimes = function() {
  var end, endDate, endTime, errorMsg, field, start, startDate, startTime, timeContainer, _i, _len, _ref;
  startDate = $('#startDate');
  startTime = $('#startTime');
  endDate = $('#endDate');
  endTime = $('#endTime');
  timeContainer = startDate.parent().parent().parent();
  errorMsg = '';
  _ref = [startDate, startTime, endDate, endTime];
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    field = _ref[_i];
    if (!field.val()) {
      errorMsg = 'Missing information.';
    }
  }
  if (!errorMsg) {
    start = new Date("" + (startDate.val()) + " " + (startTime.val())).getTime();
    end = new Date("" + (endDate.val()) + " " + (endTime.val())).getTime();
    start /= 1000;
    end /= 1000;
    if (start > end) {
      errorMsg = 'Start time is later than end time.';
    }
    if (start === end) {
      errorMsg = 'Start time is the same as end time.';
    }
  }
  if (errorMsg) {
    timeContainer.addClass('error');
    $('.errorMsgTime').remove();
    startDate.parent().parent().append("<span class='help-inline " + ("errorMsgTime'>" + errorMsg + "</span>"));
    return null;
  } else {
    timeContainer.removeClass('error');
    $('.errorMsgTime').remove();
    return {
      'start': start,
      'end': end
    };
  }
};

getResultDelay = function() {
  return parseInt($('#result-delay').val());
};

isUniversalElection = function() {
  return $('#universal-election').attr('checked') === 'checked';
};
