<!-- Load JS / CSS
================================================== -->
<link href="css/datepicker.css" rel="stylesheet">
<link href="css/timepicker.css" rel="stylesheet">
<script src="js/prettify.js" type="text/javascript"></script>
<script src="js/bootstrap-datepicker.js"></script>
<script src="js/bootstrap-timepicker.js"></script>
<script src="js/bootstrap-tooltip.js"></script>
<section id="main">
 <!-- PUT CONTENT IN HERE
================================================== --> 
  <form class="form-horizontal well" id="createForm">
    <fieldset>
      <legend>Election Information</legend>
      <div class="control-group">
        <label class="control-label" for="organization">Organization</label>
        <div class="controls">
          <select id="organization" class="input-xlarge">
            <option>Brown College</option>
          </select>
        </div>
      </div>
      
      <!-- Election Name -->
      <div class="control-group">
        <label class="control-label" for="name">Election Name</label>
        <div class="controls">
          <input type="text" class="input-xlarge" id="name">
        </div>
      </div>

      <!-- Start and End Date Time -->
      <div class="control-group">
        <label class="control-label">Voting Times</label>
        <div class="controls controls-row">
          <!-- Start Date -->
          <div class="input-append date" data-date-format="mm/dd/yy">
            <input class="input-mini" size="16" type="text" readonly="" id="startDate">
            <span class="add-on"><i class="icon-calendar"></i></span>
          </div>
          <!-- Start Time -->
          <div class="input-append bootstrap-timepicker-component">
            <input class="input-mini timepicker-default" type="text" id="startTime">
            <span class="add-on"><i class="icon-time"></i></span>
          </div>

          <span class="help-inline">-</span>

          <!-- End Date -->
          <div class="input-append date" data-date-format="mm/dd/yy">
            <input class="input-mini" size="16" type="text" readonly="" id="endDate">
            <span class="add-on"><i class="icon-calendar"></i></span>
          </div>
          <!-- End Time -->
          <div class="input-append bootstrap-timepicker-component">
            <input class="input-mini timepicker-default" type="text" id="endTime">
            <span class="add-on"><i class="icon-time"></i></span>
          </div>
        </div>
      </div>
      <!-- Eligible Voters -->
      <div class="control-group">
        <label class="control-label" for="eligible-voters">Eligible Voters</label>
        <div class="controls">
          <textarea class="span5" id="eligible-voters" rows="5" placeholder="Comma separated NetIDs"></textarea>
        </div>
      </div>
      
      <!-- Add Positions -->
      <div class="control-group">
        <label class="control-label" for="positions">Positions</label>
        <div class="controls" id="positions">
          <a data-toggle="modal" href="#addPositions" class="btn">Add Position</a>
          <div id="positions-list"></div>
        </div>
      </div>
      
      <!-- Add Positions Modal -->
      <div id="addPositions" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="addPositionsLabel" aria-hidden="true">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
          <h3 id="addPositionsLabel">Add Position</h3>
        </div>
        <div class="modal-body">
          <div class="control-group">
            <label class="control-label" for="position-select-type">Position type</label>
            <div class="controls">
              <select id="position-select-type">
                <option id="ranked-choice" value="0">Ranked-Choice Voting Position</option>
                <option id="single-choice" value="1">Single-Choice Voting Position</option>
              </select>
            </div>
          </div>
          
          <!-- Single Person Position -->
          <div class="selection-content" id="0">
            <h4>Ranked-Choice Voting Position</h4>
            <p>Ranked-Choice Voting (also known as instant runoff voting) allows voters to rank a first, second, third (and onwards) choice candidate for a single position. This makes it possible to elect people by majority vote without the need for a separate run-off election.</p>
          </div>
          
          <!-- Multiple People Position -->
          <div class="selection-content" id="1" style="display:none">
            <h4>Single-Choice Voting Position</h4>
            <p>Single-Choice voting allows voters to only vote for a single candidate for a position.</p>
          </div>
          
          <hr>
            <form>
              <fieldset>
                <!-- Position Name -->
                <div class="control-group">
                  <label class="control-label" for="position-name">Position Name</label>
                  <div class="controls">
                    <input type="text" class="input-xlarge" id="position-name">
                  </div>
                </div>
                
                <div class="control-group">
                  <label class="control-label" for="position-slots" rel="tooltip" data-placement="right" data-original-title="Number of people that will be elected for the position.">Position Slots</label>
                  <div class="controls">
                    <input type="number" class="input-mini" name="slots" min="1" max="10" id="position-slots" value="1">
                  </div>
                </div>
                
                <div class="control-group">
                  <label class="control-label" for="position-candidates">Candidates<br /></label>
                  <div class="controls">
                    <div class="add-on btn" id="position-add-candidate" style="margin-bottom:5px;"><i class="icon-plus"></i></div>
                    <div style="margin-bottom: 5px;" id="position-candidates"></div>
                  </div>
                </div>
              </fieldset>
            </form>
        </div>
        <div class="modal-footer">
          <button class="btn" data-dismiss="modal">Close</button>
          <span id="position-add-submit" class="btn btn-primary">Add Position</span>
        </div>
      </div>
      
      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Continue</button>
        <button type="reset" class="btn">Cancel</button>
      </div>
    </fieldset>
  </form>
</section>
<script type="text/javascript">
    var positions = [];         // Contains the positions added in the election where each position is a literal object
    
    $(document).ready(function () {
        // Initialize the date / time pickers.
        $('#startDate').parent().datepicker();
        $('#startTime').timepicker({
                minuteStep: 5,
        });
        $('#endDate').parent().datepicker();
        $('#endTime').timepicker({
                minuteStep: 5,
        });
        
        // Form validation
        $('#createForm').submit(validateForm);
        $('#createForm').bind('reset', function() {
            console.log('Form Reset');
            resetPositionForm();
            positions = [];
            $('#positions-list').children().remove();
        });
        
        $('label[rel="tooltip"]').tooltip();
        
        
    });
    
    function validateForm() {
        var valid = true;
        var formData = [getElectionName(), getElectionTimes(), getEligibleVoters(), getPositions()];
        $.each(formData, function(index, value) {
            if (value == null) {
                valid = false;
            }
        });
        console.log(formData);
        if (valid) {
            return true;
        } else {
            // Animate to name
            $('html, body').animate({
                scrollTop: $('#createForm').offset().top
            }, 500);
            return false;
        }
    }
    
    function getElectionName() {
        var name = $('#name');
        var nameContainer = name.parent().parent();
        if (name.val() == '') {   // Name not specified
            // Mark error if not already marked
            if (!nameContainer.hasClass('error')) {
                nameContainer.addClass('error');
                
                $('<span class="help-inline errorMsgName">Please enter election name.</span>').insertAfter(name);
            }
            return null;
        }
        
        // Valid election name
        if (nameContainer.hasClass('error')) {    // Remove error mark
            nameContainer.removeClass('error');
            $('.errorMsgName').remove();
        }
        return name.val();
        
    }
    
    function getElectionTimes() {
        var startDate = $('#startDate');
        var startTime = $('#startTime');
        var endDate = $('#endDate');
        var endTime = $('#endTime');
        var timeContainer = startDate.parent().parent().parent();
        var errorMessage = '';
        var start;      // Return val
        var end;        // Return val
        
        // Make sure user has entered all information
        if (!startDate.val() || !startTime.val() || !endDate.val() || !endTime.val()) {
            errorMessage = 'Missing information.';
        }
        
        if (!errorMessage) {
            // Validate start and end date / time
            var start = new Date(startDate.val() + ' ' + startTime.val()).getTime();
            var end = new Date(endDate.val() + ' ' + endTime.val()).getTime();
            console.log(start);
            console.log(end);
            if (start > end) {
                errorMessage = 'Start time is later than end time.';
            }
            if (start == end) {
                errorMessage = 'Start time is the same as end time.';
            }
        }
        
        
        if (errorMessage) {
            // Mark error if not already marked
            if (!timeContainer.hasClass('error')) {
                timeContainer.addClass('error');
            }
            
            // Clear existing error message
            $('.errorMsgTime').remove();
            
            // Add new error message
            startDate.parent().parent().append('<span class="help-inline errorMsgTime">' + errorMessage + '</span>');
            return null;
        } else {
            timeContainer.removeClass('error');
            $('.errorMsgTime').remove();
            return {'start': start, 'end': end};
        }
    }
    
    function getEligibleVoters() {
        var voters = $('#eligible-voters');
        var votersContainer = voters.parent().parent();
        var errorMessage = '';
        var votersList = [];     // Return val
        $.each(voters.val().split(','), function(index, value) {
            var voter = value.trim();
            if (voter) {
                votersList.push(voter);
            }
        });
        
        if (votersList.length == 0) {   // Name not specified
            errorMessage = 'Missing information.';
        }
        
        // Remove existing errors
        votersContainer.removeClass('error');
        $('.errorMsgEligibleVoters').remove();
        console.log(errorMessage);
        if (errorMessage) {
            votersContainer.addClass('error');
            $('<span class="help-inline errorMsgEligibleVoters">' + errorMessage + '</span>').insertAfter(voters);
            return null;
        }
        return votersList;
    }
    
    function getPositions() {
        return null;
    }
    
    /********************** Add Position Modal Popup **********************/
    var candidatesIDs = [];      // List of HTML IDs of candidates added to the form    
    var candidateIDGen = 0;      // Generator for candidate IDs
    var candidateIDPrefix = 'position-candidate-';

    $('#position-select-type').change(function() {
        // Hide all of the other selection content
        $('.selection-content').hide();
        var selectedId = $(this).val();
        $('#' + selectedId).show();
    });
    
    $('#position-add-candidate').click(function() {
        var index = candidateIDGen++;
        var id = candidateIDPrefix + index;
        var candidateInput = $('<div class="input-append" style="margin-top:3px; margin-bottom:3px;">' +
            '<input type="text" class="input-xlarge" id="' + id + '-name" placeholder="Candidate Name">' +
            '<span class="add-on" id="' + id + '"><i class="icon-remove"></i></span></div>');
        $('#position-candidates').append(candidateInput);
        
        candidateInput.hide().fadeIn(500);
        candidatesIDs.push(index);
        
        $('#'+id).click(function() {
            var indexPtr = candidatesIDs.indexOf(index);
            if (indexPtr != -1) {
              candidatesIDs.splice(indexPtr, 1);
            }
            $(this).parent().fadeOut(500);
        });
    });
    
    function resetPositionForm()  {
        $('#position-select-type').val('0').change();
        candidatesIDs = [];
        $('#position-candidates').children().remove();
        $('#position-slots').val('1').change();
        $('#position-name').val('').change();
    }
    
    function getPositionType() {
        if ($('#ranked-choice').attr('selected') == 'selected') {
            return 'Ranked-Choice';
        } else if ($('#single-choice').attr('selected') == 'selected') {
            return 'Single-Choice';
        }
    }
    
    // TODO: Trim input
    function getPositionName() {
        var positionName = $('#position-name');
        var positionNameContainer = positionName.parent().parent();
        // Remove existing errors
        positionNameContainer.removeClass('error');
        $('.errorMsgPositionName').remove();
        if (positionName.val() == '') {
            positionNameContainer.addClass('error');
            $('<span class="help-inline errorMsgPositionName">Missing information.</span>').insertAfter($('#position-name'));
            return null;
        }
        return positionName.val();
    }
    
    // TODO: Trim input
    function getSlots() {
        var slots = $('#position-slots');
        var slotsContainer = slots.parent().parent();
        // Remove existing errors
        slotsContainer.removeClass('error');
        $('.errorMsgSlots').remove();
        if (!(slots.attr('min') <= slots.val() && slots.val() <= slots.attr('max'))) {
            slotsContainer.addClass('error');
            $('<span class="help-inline errorMsgSlots">Out of valid range.</span>').insertAfter(slots)
            return null;
        } else if (slots.val() > candidatesIDs.length) {
            slotsContainer.addClass('error');
            $('<span class="help-inline errorMsgSlots">Number of slots exceed number of candidates.</span>').insertAfter(slots);
            return null;
        }
        return slots.val();
    }
    
    // TODO: Trim input
    function getCandidateNames() {
        var missingInformation = false;
        var candidateNameContainer = $('#position-candidates').parent().parent();
        var candidateNames = [];        // Function output
        
        // Make sure the candidate name is defined for all candidates
        $.each(candidatesIDs, function(index, value) {
            var candidateNameInput = $('#position-candidate-' + value + '-name');
            if (candidateNameInput.val() == '') {
                missingInformation = true;
            } else {
                candidateNames.push(candidateNameInput.val());
            }
        });
        
        // Remove existing errors
        $('.errorMsgCandidateName').remove();
        candidateNameContainer.removeClass('error');
        if (missingInformation) {
            candidateNameContainer.addClass('error');
            $('<span class="help-inline errorMsgCandidateName">Missing information.</span>').insertAfter(
                $('#position-candidates'));
            return null;
        }
        
        return candidateNames;
    }
    
    function displayPosition(position) {
        var html = '<div style="margin: 5px 0 5px;"><strong>' + position['type'] + ': </strong>' + position['name'] + '<br /><ul>';
        $.each(position['candidates'], function(index, value) {
           html +=  '<li>' + value + '</li>';
        });
        html += '</ul>';
        var newPos = $(html);
        $('#positions-list').append(newPos);
        newPos.hide().slideDown(1000);
    }
    
    $('#position-add-submit').click(function() {
        var valid = true;
        var formData = [getPositionType(), getPositionName(), getSlots(), getCandidateNames()];
        $.each(formData, function(index, value) {
            if (value == null) {
                valid = false;
            }
        });
        if (valid) {
            var position = {'type': formData[0], 'name': formData[1], 'slots': formData[2], 'candidates': formData[3]};
            positions.push(position);
            displayPosition(position);
            $('#addPositions').modal('hide');
            resetPositionForm();
        }
    });
</script>